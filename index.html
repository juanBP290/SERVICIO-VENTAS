<script>
  // Usuario y contraseÃ±a
  const USER = "admin";
  const PASS = "1234";
  // SheetDB API
  const SHEETDB_API = "https://sheetdb.io/api/v1/piot8q1ns1nzv";

  function isLoggedIn() {
    return sessionStorage.getItem("sessionActiva") === "SI";
  }
  function setLoggedIn(state) {
    if(state) sessionStorage.setItem("sessionActiva", "SI");
    else sessionStorage.removeItem("sessionActiva");
  }

  if(isLoggedIn()) {
    document.getElementById("loginModal").classList.add("hidden");
    document.getElementById("mainContent").classList.remove("hidden");
    fetchAndRender();
  }

  document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const usuario = form.usuario.value.trim();
    const password = form.password.value;
    if (usuario === USER && password === PASS) {
      setLoggedIn(true);
      document.getElementById("loginModal").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      fetchAndRender();
    } else {
      document.getElementById("loginError").classList.remove("hidden");
      setTimeout(() => {
        document.getElementById("loginError").classList.add("hidden");
      }, 2000);
    }
  };

  document.getElementById("logoutBtn").onclick = function() {
    setLoggedIn(false);
    window.location.reload();
  };

  let entries = [];
  let filtered = [];
  let currentPage = 1;
  const perPage = 25;

  function fetchAndRender() {
    fetch(SHEETDB_API)
      .then(res => res.json())
      .then(data => {
        entries = data.map((e, idx) => ({
          id: idx + 1,
          fecha: e.fecha || "",
          placa: e.placa || "",
          marca: e["marca/mod"] || "",
          motor: e.motor || "",
          km: e.km || "",
          tiempo: e.tiempo || "",
          oem: e["codigo oem"] || "",
          interno: e["cod interno"] || "",
          descripcion: e.descripcion || "",
          total: e.total || "",
        }));
        unifiedSearch(); // para mostrar todo al cargar
      })
      .catch(err => {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-500">Error al cargar los datos</td></tr>`;
      });
  }

  // BUSQUEDA GENERAL EN LOS 3 CAMPOS
  function unifiedSearch() {
    const value1 = document.getElementById('searchInput').value;
    const value2 = document.getElementById('searchCodigo').value;
    const value3 = document.getElementById('searchCodigo2').value;
    const combinedSearch = (value1 + " " + value2 + " " + value3).trim().toLowerCase();

    filtered = entries.filter(e =>
      Object.values(e).some(val =>
        String(val).toLowerCase().includes(combinedSearch)
      )
    );
    currentPage = 1;
    renderTable();
    renderPagination();
  }

  document.getElementById('searchInput').oninput = unifiedSearch;
  document.getElementById('searchCodigo').oninput = unifiedSearch;
  document.getElementById('searchCodigo2').oninput = unifiedSearch;

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if (filtered.length === 0) {
      tbody.innerHTML = `<tr>
        <td colspan="10" class="px-6 py-4 text-center text-gray-500">
          No se encontraron resultados
        </td>
      </tr>`;
      return;
    }
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    filtered.slice(start, end).forEach(entry => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="col-fecha px-1 py-1">${entry.fecha}</td>
        <td class="col-placa px-1 py-1">${entry.placa}</td>
        <td class="col-marca px-1 py-1">${entry.marca}</td>
        <td class="col-motor px-1 py-1">${entry.motor}</td>
        <td class="col-km px-1 py-1">${entry.km}</td>
        <td class="col-tiempo px-1 py-1">${entry.tiempo}</td>
        <td class="col-oem px-1 py-1">${entry.oem}</td>
        <td class="col-interno px-1 py-1">${entry.interno}</td>
        <td class="col-descripcion px-1 py-1">${entry.descripcion}</td>
        <td class="col-total px-1 py-1 font-semibold text-blue-800">${entry.total !== "" ? "S/" + Number(entry.total).toFixed(2) : ""}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function renderPagination() {
    const pagDiv = document.getElementById('pagination');
    pagDiv.innerHTML = '';
    const total = filtered.length;
    const totalPages = Math.ceil(total / perPage);
    if(totalPages <= 1) return;
    const pag = [];
    pag.push(`<button class="px-2 py-1 border rounded ${currentPage===1?"text-gray-400":"text-gray-700 hover:bg-gray-100"} mr-1" ${currentPage===1?"disabled":""} onclick="goToPageJs(${currentPage-1})">Anterior</button>`);
    let maxShow = 3;
    let startPage = Math.max(1, currentPage - maxShow);
    let endPage = Math.min(totalPages, currentPage + maxShow);
    if (startPage > 1) {
      pag.push(`<button class="px-2 py-1 border rounded text-blue-600 hover:bg-blue-50 mr-1" onclick="goToPageJs(1)">1</button>`);
      if (startPage > 2) pag.push(`<span class="px-2">...</span>`);
    }
    for (let i = startPage; i <= endPage; i++) {
      pag.push(
        i === currentPage
        ? `<span class="px-2 py-1 border rounded bg-blue-600 text-white mr-1">${i}</span>`
        : `<button class="px-2 py-1 border rounded text-blue-600 hover:bg-blue-50 mr-1" onclick="goToPageJs(${i})">${i}</button>`
      );
    }
    if (endPage < totalPages) {
      if (endPage < totalPages-1) pag.push(`<span class="px-2">...</span>`);
      pag.push(`<button class="px-2 py-1 border rounded text-blue-600 hover:bg-blue-50 mr-1" onclick="goToPageJs(${totalPages})">${totalPages}</button>`);
    }
    pag.push(`<button class="px-2 py-1 border rounded ${currentPage===totalPages?"text-gray-400":"text-gray-700 hover:bg-gray-100"} ml-1" ${currentPage===totalPages?"disabled":""} onclick="goToPageJs(${currentPage+1})">Siguiente</button>`);
    pagDiv.innerHTML = pag.join('');
  }

  window.goToPageJs = function(n) {
    currentPage = n;
    renderTable();
    renderPagination();
    document.getElementById('productsTable').scrollIntoView({behavior:'smooth'});
  }
</script>



